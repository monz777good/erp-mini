"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";

type Item = { id: string; name: string };

function digitsOnly(v: string) {
  return (v ?? "").replace(/\D/g, "");
}

export default function OrdersPage() {
  const router = useRouter();

  const [items, setItems] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);

  // ✅ 품목 검색
  const [q, setQ] = useState("");

  // ✅ 선택 품목
  const [itemId, setItemId] = useState<string>("");

  // ✅ 주문 정보
  const [receiverName, setReceiverName] = useState("");
  const [receiverAddr, setReceiverAddr] = useState("");
  const [receiverPhone, setReceiverPhone] = useState("");
  const [receiverMobile, setReceiverMobile] = useState("");
  const [quantity, setQuantity] = useState<number>(1);
  const [note, setNote] = useState("");

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch("/api/items", { credentials: "include" });
        const data = await res.json();
        const list = Array.isArray(data) ? data : data?.items ?? [];
        setItems(list);
        if (list.length > 0) setItemId(list[0].id);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  const filtered = useMemo(() => {
    const k = q.trim().toLowerCase();
    if (!k) return items;
    return items.filter((it) => (it.name ?? "").toLowerCase().includes(k));
  }, [items, q]);

  useEffect(() => {
    if (filtered.length === 0) return;
    const exists = filtered.some((x) => x.id === itemId);
    if (!exists) setItemId(filtered[0].id);
  }, [filtered, itemId]);

  async function logout() {
    const tryUrls = ["/api/logout", "/api/auth/logout"];

    for (const url of tryUrls) {
      const res = await fetch(url, { method: "POST", credentials: "include" }).catch(() => null);
      if (res && res.ok) {
        router.replace("/login");
        return;
      }
    }

    for (const url of tryUrls) {
      const res = await fetch(url, { method: "GET", credentials: "include" }).catch(() => null);
      if (res && res.ok) {
        router.replace("/login");
        return;
      }
    }

    alert("로그아웃 API를 찾지 못했습니다. (/api/logout 또는 /api/auth/logout 필요)");
  }

  async function submitOrder() {
    if (!itemId) return alert("품목을 선택해주세요.");
    if (!receiverName.trim()) return alert("수하인(받는 사람)을 입력해주세요.");
    if (!receiverAddr.trim()) return alert("주소를 입력해주세요.");
    if (!quantity || quantity < 1) return alert("수량은 1 이상이어야 합니다.");

    const phone = digitsOnly(receiverPhone);
    const mobile = digitsOnly(receiverMobile);

    const res = await fetch("/api/orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({
        itemId,
        quantity,
        receiverName: receiverName.trim(),
        receiverAddr: receiverAddr.trim(),
        receiverPhone: phone || "",
        receiverMobile: mobile || "",
        note: note?.trim() ? note.trim() : null,
      }),
    });

    if (!res.ok) {
      const msg = await res.json().catch(() => ({}));
      alert(msg?.message ?? "주문요청 실패");
      return;
    }

    alert("주문요청 완료");
    setNote("");
    setQuantity(1);
    setReceiverName("");
    setReceiverAddr("");
    setReceiverPhone("");
    setReceiverMobile("");
  }

  const wrap: React.CSSProperties = { padding: 24, maxWidth: 820, margin: "0 auto" };
  const label: React.CSSProperties = { fontWeight: 900, marginBottom: 6 };
  const input: React.CSSProperties = {
    width: "100%",
    padding: "10px 12px",
    border: "1px solid #ddd",
    borderRadius: 12,
    outline: "none",
  };

  return (
    <div>
      {/* ✅ 상단 네비 (SALES에서는 '품목' 버튼 제거) */}
      <div
        style={{
          height: 64,
          borderBottom: "1px solid #eee",
          display: "flex",
          alignItems: "center",
          padding: "0 18px",
          gap: 10,
        }}
      >
        <div style={{ fontWeight: 900 }}>ERP Mini</div>

        {/* ✅ 주문 버튼만 유지 */}
        <button
          onClick={() => router.push("/orders")}
          style={{
            marginLeft: 10,
            padding: "8px 12px",
            borderRadius: 12,
            border: "1px solid #111",
            background: "#111",
            color: "white",
            fontWeight: 900,
          }}
        >
          주문
        </button>

        {/* ❌ '품목' 버튼 제거됨 */}

        <div style={{ marginLeft: "auto", display: "flex", alignItems: "center", gap: 10 }}>
          <div style={{ color: "#666", fontWeight: 800 }}>SALES</div>
          <button
            onClick={logout}
            style={{
              padding: "8px 12px",
              borderRadius: 12,
              border: "1px solid #ddd",
              background: "white",
              fontWeight: 900,
            }}
          >
            로그아웃
          </button>
        </div>
      </div>

      <div style={wrap}>
        <h1 style={{ fontSize: 26, fontWeight: 900, marginBottom: 12 }}>주문요청</h1>

        {loading ? (
          <div>불러오는 중...</div>
        ) : (
          <>
            <div style={{ marginBottom: 10 }}>
              <div style={label}>품목 검색</div>
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                placeholder="예) 죽염 1.8, 자하거, PDRN..."
                style={input}
              />
              <div style={{ marginTop: 6, color: "#666", fontWeight: 800 }}>
                {filtered.length}개 표시됨 (전체 {items.length}개)
              </div>
            </div>

            <div style={{ marginBottom: 14 }}>
              <div style={label}>품목 선택</div>

              {filtered.length === 0 ? (
                <div style={{ padding: 12, border: "1px solid #eee", borderRadius: 12, color: "#777" }}>
                  검색 결과가 없습니다.
                </div>
              ) : (
                <select
                  value={itemId}
                  onChange={(e) => setItemId(e.target.value)}
                  style={{
                    width: "100%",
                    padding: "10px 12px",
                    border: "1px solid #ddd",
                    borderRadius: 12,
                    fontWeight: 800,
                  }}
                >
                  {filtered.map((it) => (
                    <option key={it.id} value={it.id}>
                      {it.name}
                    </option>
                  ))}
                </select>
              )}
            </div>

            <div style={{ marginBottom: 14 }}>
              <div style={label}>수량</div>
              <input
                type="number"
                min={1}
                value={quantity}
                onChange={(e) => setQuantity(Math.max(1, Number(e.target.value || 1)))}
                style={input}
              />
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12, marginBottom: 14 }}>
              <div>
                <div style={label}>수하인(받는 사람)</div>
                <input
                  value={receiverName}
                  onChange={(e) => setReceiverName(e.target.value)}
                  placeholder="예) 홍길동"
                  style={input}
                />
              </div>

              <div>
                <div style={label}>핸드폰</div>
                <input
                  value={receiverMobile}
                  onChange={(e) => setReceiverMobile(e.target.value)}
                  placeholder="예) 010-1234-5678"
                  style={input}
                />
                <div style={{ marginTop: 6, color: "#777", fontWeight: 700, fontSize: 12 }}>
                  숫자만 저장됨 (하이픈 입력해도 됨)
                </div>
              </div>
            </div>

            <div style={{ marginBottom: 14 }}>
              <div style={label}>주소</div>
              <input
                value={receiverAddr}
                onChange={(e) => setReceiverAddr(e.target.value)}
                placeholder="예) 경기도 시흥시 ..."
                style={input}
              />
            </div>

            <div style={{ marginBottom: 14 }}>
              <div style={label}>전화(일반전화, 없으면 공백)</div>
              <input
                value={receiverPhone}
                onChange={(e) => setReceiverPhone(e.target.value)}
                placeholder="예) 031-123-4567"
                style={input}
              />
              <div style={{ marginTop: 6, color: "#777", fontWeight: 700, fontSize: 12 }}>
                숫자만 저장됨 (하이픈 입력해도 됨)
              </div>
            </div>

            <div style={{ marginBottom: 14 }}>
              <div style={label}>요청 메모(선택)</div>
              <input
                value={note}
                onChange={(e) => setNote(e.target.value)}
                placeholder="예) 취급주의 / 내일 오전 요청"
                style={input}
              />
            </div>

            <button
              onClick={submitOrder}
              disabled={!itemId}
              style={{
                width: "100%",
                padding: "12px 14px",
                borderRadius: 12,
                border: "1px solid #111",
                background: "#111",
                color: "white",
                fontWeight: 900,
              }}
            >
              주문요청 제출
            </button>
          </>
        )}
      </div>
    </div>
  );
}
